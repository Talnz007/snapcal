<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üì∏ SnapCal ‚Äì Chrome Extension</title>
  <style>
    /* Inline CSS instead of Tailwind CDN */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 50%, #f3e8ff 100%);
      padding: 16px;
      width: 400px;
      min-height: 500px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      border: 1px solid #e5e7eb;
    }
    .header { text-align: center; margin-bottom: 24px; }
    .title { 
      font-size: 24px; 
      font-weight: 800; 
      color: #4338ca; 
      margin-bottom: 8px; 
    }
    .subtitle { color: #6b7280; font-size: 14px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: #4338ca; color: white; }
    .btn-primary:hover { background: #3730a3; }
    .btn-green { background: #059669; color: white; }
    .btn-green:hover { background: #047857; }
    .btn-blue { background: #2563eb; color: white; }
    .btn-blue:hover { background: #1d4ed8; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .input-group { margin: 16px 0; }
    .label { 
      display: block; 
      font-size: 12px; 
      font-weight: 600; 
      color: #374151; 
      margin-bottom: 4px; 
    }
    .file-input {
      width: 100%;
      font-size: 12px;
      color: #6b7280;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
    }
    .textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      resize: none;
      font-family: inherit;
    }
    .status {
      font-size: 12px;
      color: #6b7280;
      background: #f9fafb;
      padding: 8px;
      border-radius: 8px;
      min-height: 24px;
      margin: 8px 0;
    }
    .output {
      margin-top: 24px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      min-height: 150px;
      color: #374151;
      border: 1px solid #e5e7eb;
      font-size: 14px;
    }
    .hidden { display: none; }
    .text-center { text-align: center; }
    .text-green { color: #059669; }
    .text-red { color: #dc2626; }
    .text-blue { color: #2563eb; }
    .bg-white { background: white; }
    .p-2 { padding: 8px; }
    .mb-1 { margin-bottom: 4px; }
    .mb-3 { margin-bottom: 12px; }
    .rounded { border-radius: 6px; }
    .border { border: 1px solid #e5e7eb; }
    .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .font-bold { font-weight: 700; }
    .text-sm { font-size: 14px; }
    .text-xs { font-size: 12px; }
    .text-lg { font-size: 18px; }
    .space-y-1 > * + * { margin-top: 4px; }
    .break-words { word-wrap: break-word; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 class="title">üì∏ SnapCal</h1>
      <p class="subtitle">Chrome Extension Math Solver</p>
    </div>

    <!-- Input Section -->
    <div>
      <div class="grid">
        <button id="captureBtn" class="btn btn-primary">
          üì∏ Capture Tab
        </button>
        <button id="textInputBtn" class="btn btn-green">
          ‚úèÔ∏è Type Problem
        </button>
      </div>

      <div class="input-group">
        <label for="imageInput" class="label">Or upload image:</label>
        <input id="imageInput" type="file" accept="image/*" class="file-input" />
      </div>

      <!-- Text Input Area (hidden by default) -->
      <div id="textInputArea" class="hidden input-group">
        <textarea id="textInput" placeholder="Type or paste your math problem here..." 
                  class="textarea" rows="3"></textarea>
        <button id="solveTextBtn" class="btn btn-blue" style="width: 100%; margin-top: 8px;">
          üßÆ Solve Problem
        </button>
      </div>

      <div id="ocrStatus" class="status"></div>

      <button id="solveBtn" class="btn btn-primary" style="width: 100%;">
        üßÆ Solve Problem
      </button>
    </div>

    <!-- Output Section -->
    <div id="output" class="output"></div>

    <!-- Status -->
    <div id="apiStatus" class="status text-center"></div>
  </div>

  <script>
    // Core variables
    let session = null;
    let extractedText = '';

    // Check for selected text from context menu
    async function checkForSelectedText() {
      try {
        const response = await chrome.runtime.sendMessage({ type: 'GET_SELECTED_TEXT' });
        if (response && response.text) {
          document.getElementById('textInput').value = response.text;
          toggleTextInput();
          document.getElementById("ocrStatus").innerHTML = `<span class='text-green-600'>‚úÖ Selected text loaded: "${response.text}"</span>`;
        }
      } catch (error) {
        console.log('No selected text available');
      }
    }

    // Toggle text input area
    function toggleTextInput() {
      const area = document.getElementById('textInputArea');
      const btn = document.getElementById('textInputBtn');
      if (area.classList.contains('hidden')) {
        area.classList.remove('hidden');
        btn.textContent = '‚ùå Cancel';
        document.getElementById('textInput').focus();
      } else {
        area.classList.add('hidden');
        btn.textContent = '‚úèÔ∏è Type Problem';
      }
    }

    // OCR function
    async function performOCR(imageFile) {
      document.getElementById("ocrStatus").innerHTML = "<span class='text-blue-600'>üîç Extracting text from image‚Ä¶</span>";
      try {
        const { data: { text } } = await Tesseract.recognize(imageFile, 'eng', {
          logger: m => console.log('OCR progress:', m)
        });
        extractedText = text.trim();
        document.getElementById("ocrStatus").innerHTML = `<span class='text-green-600'>‚úÖ Extracted text: <strong>"${extractedText}"</strong></span>`;
        console.log("OCR result:", extractedText);
        return extractedText;
      } catch (e) {
        document.getElementById("ocrStatus").innerHTML = `<span class='text-red-600'>‚ùå OCR failed: ${e.message}</span>`;
        return '';
      }
    }

    // API detection (same as working PWA)
    async function checkAvailability(retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          if (typeof LanguageModel !== "undefined") {
            const availability = await LanguageModel.availability();
            if (availability === "available") {
              document.getElementById("apiStatus").innerHTML = "‚úÖ Gemini Nano ready (LanguageModel API)!";
              return "languagemodel";
            }
          } else if (typeof ai !== "undefined" && ai.languageModel) {
            const capabilities = await ai.languageModel.capabilities();
            if (capabilities.available === "readily") {
              document.getElementById("apiStatus").innerHTML = "‚úÖ Gemini Nano ready (ai.languageModel API)!";
              return "ai";
            }
          }
          document.getElementById("apiStatus").innerHTML = "‚ùå Gemini Nano API not available.";
          return false;
        } catch (err) {
          console.error("Availability check error:", err);
          document.getElementById("apiStatus").innerHTML = `‚ö†Ô∏è Error: ${err.message}`;
          if (i === retries - 1) return false;
        }
      }
    }

    async function initSession(apiType) {
      if (session) return session;
      try {
        if (apiType === "languagemodel") {
          session = await LanguageModel.create({ temperature: 0.3, topK: 3, outputLanguage: 'en' });
        } else if (apiType === "ai") {
          session = await ai.languageModel.create({ temperature: 0.3, topK: 3, outputLanguage: 'en' });
        }
        console.log("‚úÖ Session created:", session);
        return session;
      } catch (e) {
        console.error("Session creation failed:", e);
        alert("Failed to create session: " + e.message);
      }
    }

    // Capture tab screenshot
    async function captureTab() {
      try {
        const response = await chrome.runtime.sendMessage({ type: 'CAPTURE_TAB' });
        if (response.error) {
          throw new Error(response.error);
        }
        
        // Convert data URL to blob
        const res = await fetch(response.dataUrl);
        const blob = await res.blob();
        
        await performOCR(blob);
      } catch (error) {
        document.getElementById("ocrStatus").innerHTML = `<span class='text-red-600'>‚ùå Capture failed: ${error.message}</span>`;
      }
    }

    // Event listeners
    document.getElementById("textInputBtn").addEventListener("click", toggleTextInput);
    
    document.getElementById("captureBtn").addEventListener("click", captureTab);

    document.getElementById("imageInput").addEventListener("change", async (event) => {
      const imageFile = event.target.files[0];
      if (imageFile) {
        await performOCR(imageFile);
      }
    });

    document.getElementById("solveTextBtn").addEventListener("click", async () => {
      const text = document.getElementById('textInput').value.trim();
      if (text) {
        extractedText = text;
        toggleTextInput();
        document.getElementById("ocrStatus").innerHTML = `<span class='text-green-600'>‚úÖ Text input: "${text}"</span>`;
      }
    });

    document.getElementById("solveBtn").addEventListener("click", async () => {
      const apiType = await checkAvailability();
      if (!apiType) return;

      if (!extractedText) {
        alert("Please capture/upload an image, or type a math problem first.");
        return;
      }

      const aiSession = await initSession(apiType);
      const button = document.getElementById("solveBtn");
      button.disabled = true;
      button.textContent = "‚è≥ Solving‚Ä¶";

      const prompt = `
Solve this math problem: "${extractedText}"

Return your answer in JSON:
{
  "answer": "the final answer in LaTeX format (e.g. x = 5)",
  "steps": ["Step 1: ...", "Step 2: ..."]
}`;

      const outputDiv = document.getElementById("output");
      outputDiv.innerHTML = "<div class='text-center text-gray-500'>‚è≥ Solving‚Ä¶</div>";

      try {
        const result = await aiSession.prompt(prompt);
        
        // Parse JSON (same as working PWA)
        let parsed;
        try {
          let jsonMatch = result.match(/```json\s*(\{[\s\S]*?\})\s*```/);
          if (!jsonMatch) {
            jsonMatch = result.match(/\{[\s\S]*?\}/);
          }
          if (jsonMatch) {
            let jsonString = jsonMatch[1] || jsonMatch[0];
            jsonString = jsonString.replace(/\\/g, '\\\\');
            parsed = JSON.parse(jsonString);
          } else {
            throw new Error("No JSON found");
          }
        } catch (parseError) {
          parsed = { answer: result, steps: [] };
        }

        // Display result
        outputDiv.innerHTML = `
          <div class="mb-3">
            <h3 class="text-sm font-bold text-indigo-700 mb-1">Answer:</h3>
            <div class="text-lg bg-white p-2 rounded border shadow-sm" id="answerDiv">\\[${parsed.answer || 'No answer'}\\]</div>
          </div>
          <div>
            <h3 class="text-sm font-bold text-indigo-700 mb-1">Steps:</h3>
            <div class="space-y-1">
              ${(parsed.steps || []).map((s, i) => `<div class="bg-white p-2 rounded border shadow-sm text-xs break-words">${i + 1}. ${s}</div>`).join("")}
            </div>
          </div>
        `;

        // Render LaTeX
        if (window.MathJax) {
          await MathJax.startup.promise;
          await MathJax.typesetPromise([outputDiv]);
        }

      } catch (e) {
        console.error("Error solving:", e);
        outputDiv.innerHTML = `<p class="text-red-600 text-center text-sm">‚ùå ${e.message}</p>`;
      } finally {
        button.disabled = false;
        button.textContent = "üßÆ Solve Problem";
      }
    });

    // Initialize
    checkAvailability();
    checkForSelectedText();
  </script>
</body>
</html>